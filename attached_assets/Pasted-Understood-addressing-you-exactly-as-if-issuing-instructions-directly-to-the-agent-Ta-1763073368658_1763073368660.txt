Understood ‚Äî addressing you exactly as if issuing instructions directly to the agent.

---

# ‚úÖ **Task 1 Completed Successfully**

All validation signals look clean. Proceeding with **Phase 1 ‚Äì Task 2**.

---

# ‚ö° **PHASE 1 ‚Äî TASK 2: Unify Database Session Management**

Your objective is to **standardize ALL database session handling** so the entire project uses **ONE** consistent pattern.

## üéØ **Goal**

Eliminate all mixed patterns (`get_session()`, `handle_db_errors()`, manual `SessionLocal()`) and replace them with a **single unified context manager** that ensures:

* Automatic session creation
* Automatic rollback on failure
* Automatic commit on success
* Automatic session closure
* Zero detached-instance regressions

---

# ‚úîÔ∏è **AGENT INSTRUCTIONS**

### **Step 1 ‚Äî Inspect existing session helpers**

Search the repo for:

* `get_session(`
* `handle_db_errors(`
* direct imports of `SessionLocal`
* any ad-hoc `session = SessionLocal()` usage
* any `with SessionLocal() as session:` blocks

Map all locations that require standardization.

---

### **Step 2 ‚Äî Choose the unified session manager**

Use *one* of the two existing patterns as the system-standard:

### **Decision: Use `handle_db_errors()` everywhere**

Reason:

* It already wraps retry logic.
* It already handles rollbacks + commits.
* It already emits logs for SQL errors.
* It is compatible with all DB operations, including writes.

‚û°Ô∏è This becomes the **canonical required pattern** across the codebase:

```python
with handle_db_errors() as session:
    ...
```

---

### **Step 3 ‚Äî Refactor all DB modules**

Update:

* `db.py`
* `executor.py`
* `cache.py`
* `data_fetcher.py` (if using DB cache)
* `monitoring.py`
* `risk.py` (if DB used)
* any scripts in `scripts/`
* any tests using `get_session()`

Remove or convert:

* `get_session()`
* manual `SessionLocal()` usage

All DB operations must use only:

```python
with handle_db_errors() as session:
    ...
```

---

### **Step 4 ‚Äî Validate no DetachedInstance regression**

During the refactor, confirm that functions which returned ORM objects (e.g., `save_bet`, `load_cache`, etc.) **clone ORM objects into detached copies** before returning.

This avoids failures like:

```
DetachedInstanceError: Parent instance <BetRecord> is not bound to a Session
```

---

### **Step 5 ‚Äî Update tests**

Tests that assume `get_session()` exists must be modified.

Search for:

```bash
grep -R "get_session" -n tests/
```

If tests create sessions manually, update them to:

```python
from src.db import handle_db_errors

with handle_db_errors() as session:
    ...
```

If tests depend on temporary sessions, create a lightweight test-only helper:

```python
from src.db import SessionLocal

def get_test_session():
    session = SessionLocal()
    try:
        yield session
    finally:
        session.close()
```

Only use this inside tests.

---

### **Step 6 ‚Äî Remove deprecated functions**

Remove `get_session()` entirely from `src/db.py`.

Delete or clean:

* unused imports (`SessionLocal`, etc.)
* now-outdated session helpers
* commented remnants

---

### **Step 7 ‚Äî Run full validation**

After refactoring:

```bash
isort .
black .
flake8
mypy
pytest -q
```

Expected:

* No new test regressions
* No new mypy errors
* No flake8 violations specific to this refactor

---

# üì¶ **Deliverables Required From the Agent**

When complete, produce a summary containing:

### 1. **List of changed files**

### 2. **Unified session manager code snippet**

### 3. **Removed/modified functions**

### 4. **Updated test locations**

### 5. **pytest/mypy/flake8/black results**

### 6. **Final commit hash**

---

# üöÄ **Proceed with Task 2 now.**

When finished, report results the same way you did for Task 1.
